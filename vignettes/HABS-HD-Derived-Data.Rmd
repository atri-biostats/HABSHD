---
title: "HABS-HD Derived Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{HABS-HD Derived Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r, include = FALSE}
library(tidyverse)

knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
```

```{r setup, purl=FALSE}
library(HABSHD)
```

# Check for and remove duplicated `Med_ID` in `Visit_ID`, remove `NA` `Med_ID`

## `HD_clinical` duplicates

```{r}
dups <- HD_Clinical %>%
  group_by(Med_ID, Visit_ID) %>%
  filter(n()>1) %>%
  select(Med_ID, Visit_ID) %>%
  distinct()

if(nrow(dups) > 0){
  dups %>%
    knitr::kable(caption = 'Duplicated Med_ID/Visit_ID found in HD_clinical. Duplicates will be removed.') %>%
    print()
  
  HD_Clinical <- HD_Clinical %>% 
    group_by(Med_ID, Visit_ID) %>%
    distinct(Med_ID, Visit_ID, .keep_all = TRUE) %>%
    filter(!is.na(Med_ID))
}else{
   message('No duplicates found.')
}
```

## `HD_Biomarkers` duplicates

```{r}
dups <- HD_Biomarkers %>%
  group_by(Med_ID, Visit_ID) %>%
  filter(n()>1) %>%
  select(Med_ID, Visit_ID) %>%
  distinct()

if(nrow(dups) > 0){
  dups %>%
    knitr::kable(caption = 'Duplicated Med_ID/Visit_ID found in HD_Biomarkers. Duplicates will be removed after filling any missing values by carrying observations backward within Visit_ID.') %>%
    print()
  
  HD_Biomarkers <- HD_Biomarkers %>% 
    group_by(Med_ID, Visit_ID) %>%
    tidyr::fill(names(.), .direction='up') %>%
    distinct(Med_ID, Visit_ID, .keep_all = TRUE) %>%
    filter(!is.na(Med_ID))
}else{
   message('No duplicates found.')
}
```

## `HD_Genomics` duplicates

```{r}
dups <- HD_Genomics %>%
  group_by(Med_ID, Visit_ID) %>%
  filter(n()>1) %>%
  select(Med_ID, Visit_ID) %>%
  distinct()

if(nrow(dups) > 0){
  dups %>%
    knitr::kable(caption = 'Duplicated Med_ID/Visit_ID found in HD_Genomics. Duplicates will be removed after filling any missing values by carrying observations backward within Visit_ID.') %>%
    print()
  
  HD_Genomics <- HD_Genomics %>% 
    group_by(Med_ID, Visit_ID) %>%
    tidyr::fill(names(.), .direction='up') %>%
    distinct(Med_ID, Visit_ID, .keep_all = TRUE) %>%
    filter(!is.na(Med_ID))
}else{
   message('No duplicates found.')
}
```

## `HD_Imaging` duplicates

```{r}
dups <- HD_Imaging %>%
  group_by(Med_ID, Visit_ID) %>%
  filter(n()>1) %>%
  select(Med_ID, Visit_ID) %>%
  distinct()

if(nrow(dups) > 0){
  dups %>%
    knitr::kable(caption = 'Duplicated Med_ID/Visit_ID found in HD_Imaging. Duplicates will be removed after filling any missing values by carrying observations backward within Visit_ID.') %>%
    print()
  
  HD_Imaging <- HD_Imaging %>% 
    group_by(Med_ID, Visit_ID) %>%
    tidyr::fill(names(.), .direction='up') %>%
    distinct(Med_ID, Visit_ID, .keep_all = TRUE) %>%
    filter(!is.na(Med_ID))
}else{
   message('No duplicates found.')
}
```

# Derive `HD_subjinfo`

`HD_subjinfo` contains key subject information on baseline characteristics. Data manipulations include:

* Missing data are filled by carrying observations back where possible
* `Mean_ICV_HD` is calculated as the mean over all visits
* `ADI_StateRank` is converted to numeric. Some character strings (e.g. "GQ", "Invalid Address", "PH") are converted to NA.

```{r}
HD_subjinfo_clinical <- HD_Clinical %>% 
  arrange(Med_ID, Visit_ID) %>%
  group_by(Med_ID) %>%
  select(Med_ID, Visit_ID, CDX_Cog, Age, Ethnicity, ID_Hispanic, ID_Race_White,
    ID_Race_Black, ID_Race_IndianAlaska, ID_Race_Specify_AmerInd_Tribe,
    ID_Race_Asian, ID_Race_Specify_Asian_Race, ID_Race_Japanese, ID_Race_Korean,
    ID_Race_Vietnamese, ID_Race_NativeHawaiian, ID_Race_GuamChamorro,
    ID_Race_Samoan, ID_Race_OtherPacific, ID_Race_Specify_OtherPacific_Race,
    ID_Race_Other, ID_Race_Specify, ID_Gender, Interview_Language,
    ID_Language_Primary, ADI_StateRank, MMSE_Total, Digit_Symbol_Substitution,
    SEVLT_DR_Total, LM2_AB_Total, Animal_Total) %>%
  tidyr::fill(names(.), .direction='up') %>%
  filter(Visit_ID == 1) %>%
  mutate(ADI_StateRank = as.numeric(ADI_StateRank)) %>%
  ungroup()

HD_subjinfo_imaging <- HD_Imaging %>% 
  arrange(Med_ID, Visit_ID) %>%
  group_by(Med_ID) %>%
  mutate(Mean_ICV_HD = mean(`01_ICV_HD`, na.rm = TRUE)) %>%
  select(`Med_ID`, `Visit_ID`,
    `01_AB_FBB_AB_pos`, `01_TAU_PI2620_Medial_Temporal_SUVR`,
    `01_L_hippocampus`, `01_R_hippocampus`, `01_ICV_HD`, `02_WMH_Volume_Raw`,
    `02_WMH_Volume_Log`) %>%
  tidyr::fill(names(.), .direction='up') %>%
  filter(Visit_ID == 1) %>%
  ungroup()

HD_subjinfo_genomics <- HD_Genomics %>% 
  arrange(Med_ID, Visit_ID) %>%
  group_by(Med_ID) %>%
  select(-Age, -Ethnicity, -ID_Education, -ID_Gender) %>%
  tidyr::fill(names(.), .direction='up') %>%
  filter(Visit_ID == 1) %>%
  ungroup()

HD_subjinfo <- HD_subjinfo_clinical %>%
  left_join(HD_subjinfo_genomics, by = c("Med_ID", "Visit_ID")) %>%
  left_join(HD_subjinfo_imaging, by = c("Med_ID", "Visit_ID"))
```

## Check for duplicated `Med_ID` in `HD_subjinfo`

```{r}
if(any(duplicated(HD_subjinfo$Med_ID))){
  message('Duplicated Med_ID found in HD_subjinfo for Visit_ID 1:',
    paste(HD_subjinfo$Med_ID[which(duplicated(HD_subjinfo$Med_ID))],
      collapse = ', '), '\n Removing second occurrence.')
  HD_subjinfo <- HD_subjinfo %>%
    distinct(Med_ID, .keep_all = TRUE)
}else{
  message('No duplicates found.')
}
```

# Derive `HPACC`

## Summarize HPACC components at baseline among cognitively normal

```{r}
pacc_summaries <-
  HD_subjinfo %>% filter(CDX_Cog=='Cognitively Unimpaired') %>% 
  select(MMSE_Total, Digit_Symbol_Substitution, SEVLT_DR_Total, LM2_AB_Total, Animal_Total) %>%
  pivot_longer(MMSE_Total:Animal_Total, names_to = 'Component', values_to = 'y') %>%
  filter(!is.na(y)) %>%
  group_by(Component) %>% 
  summarise(
    N=length(y),
    Min=min(y),
    Q1=quantile(y,probs=0.25)[[1]],
    Median = median(y),
    Mean = mean(y),
    SD = sd(y),
    Q3 = quantile(y,probs=0.75)[[1]],
    Max = max(y)
  )

knitr::kable(pacc_summaries, caption = 'HPACC component summaries among cognitively unimpaired at baseline.', digits = 2)
```

## Generate HPACC Z scores for `HD_subjinfo` and `HD_Clincal`

```{r}
for(cc in pacc_summaries$Component){
  x <- filter(pacc_summaries, Component == cc)
  HD_subjinfo[,paste0(cc, '_Z')] <- (HD_subjinfo %>% pull(cc) - x$Mean)/x$SD
  HD_Clinical[,paste0(cc, '_Z')] <- 
    (HD_Clinical %>% pull(cc) - x$Mean)/x$SD
}
```

## Sum HPACC Z scores to form `HPACC` in `HD_subjinfo` and `HD_Clinical`

```{r}
HD_subjinfo$HPACC <- apply(HD_subjinfo[, paste0(pacc_summaries$Component, '_Z')], 1, sum)
HD_subjinfo$HPACC_NA <- apply(is.na(HD_subjinfo[, paste0(pacc_summaries$Component, '_Z')]), 1, sum)
HD_subjinfo$HPACC_NAsum <- apply(HD_subjinfo[, paste0(pacc_summaries$Component, '_Z')], 1, sum, na.rm=TRUE)
HD_subjinfo <- HD_subjinfo %>% mutate(
  HPACC_Prorated = case_when(
    HPACC_NA == 0 ~ HPACC,
    HPACC_NA == 1 ~ HPACC_NAsum * 5 / 4,
    HPACC_NA == 2 ~ HPACC_NAsum * 5 / 3
  ))
HD_subjinfo <- HD_subjinfo %>% mutate(-HPACC_NAsum)

HD_Clinical$HPACC <- apply(HD_Clinical[, paste0(pacc_summaries$Component, '_Z')], 1, sum)
HD_Clinical$HPACC_NA <- apply(is.na(HD_Clinical[, paste0(pacc_summaries$Component, '_Z')]), 1, sum)
HD_Clinical$HPACC_NAsum <- apply(HD_Clinical[, paste0(pacc_summaries$Component, '_Z')], 1, sum, na.rm=TRUE)
HD_Clinical <- HD_Clinical %>% mutate(
  HPACC_Prorated = case_when(
    HPACC_NA == 0 ~ HPACC,
    HPACC_NA == 1 ~ HPACC_NAsum * 5 / 4,
    HPACC_NA == 2 ~ HPACC_NAsum * 5 / 3
  ))
HD_Clinical <- HD_Clinical %>% select(-HPACC_NAsum)
```

# Create `HD_labels`

`HD_labels` are human friendly versions of variable names stored as a character vector. The names of the vector components correspond to variable names (e.g. `ID_Hispanic`) and values correspond to labels (e.g. Hispanic). Manipulations include:

* Remove `ID_`, `01_`, `02_`
* Convert `_` to a blank space

```{r}
HD_labels <- colnames(HD_subjinfo)
names(HD_labels) <- HD_labels
HD_labels <- HD_labels %>%
  gsub(pattern = 'ID_', replacement = '') %>%
  gsub(pattern = '01_', replacement = '') %>%
  gsub(pattern = '02_', replacement = '') %>%
  gsub(pattern = '_', replacement = ' ')
```